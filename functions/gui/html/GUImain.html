
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>GUImain</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-10-29"><meta name="DC.source" content="GUImain.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">TRacer Main GUI v0.1</a></li><li><a href="#3">Main Figure</a></li><li><a href="#6">UI Tables</a></li><li><a href="#10">Popup Menus (Comboboxes)</a></li><li><a href="#11">Variables, Handles and Window Positions</a></li><li><a href="#13">CALLBACK FUNCTIONS</a></li><li><a href="#14">Main GUI Callbacks</a></li><li><a href="#15">Checkbox Callbacks</a></li><li><a href="#16">Button Callbacks</a></li><li><a href="#18">generate totalimg &amp; cancel noise</a></li><li><a href="#19">perform particle recognition</a></li><li><a href="#21">Slider Callbacks</a></li><li><a href="#22">MouseMove and ButtonDown Callbacks</a></li><li><a href="#23">Listbox Function</a></li><li><a href="#24">ALEX Callback</a></li><li><a href="#25">Other GUI functions</a></li></ul></div><h2>TRacer Main GUI v0.1<a name="1"></a></h2><pre class="language-matlab">generates <span class="string">main</span> <span class="string">figure</span>
</pre><pre class="codeinput"><span class="keyword">function</span> GUImain()
</pre><pre class="codeinput"><span class="keyword">global</span> h prefs res img;
</pre><h2>Main Figure<a name="3"></a></h2><pre class="codeinput">set(0, <span class="string">'defaultAxesXColor'</span>, <span class="string">'w'</span>,<span class="keyword">...</span>
    <span class="string">'defaultAxesYColor'</span>, <span class="string">'w'</span>);

h.main = figure(<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'TRACER: Main Experiment Window'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'units'</span>, <span class="string">'normalized'</span>, <span class="keyword">...</span>
    <span class="string">'OuterPosition'</span>, [0 0 1 1],<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>, prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'CloseRequestFcn'</span>, @main_close,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Toolbar'</span>, <span class="string">'none'</span>);

prefs.WS = get(h.main, <span class="string">'Position'</span>);
set(h.main, <span class="string">'Position'</span>, prefs.WS + [0,39,0,-40]);  <span class="comment">% correct figure for Taskbar height</span>
</pre><img vspace="5" hspace="5" src="GUImain_01.png" alt=""> <pre class="codeinput"><span class="comment">%%	UI Panels</span>

h.axesPanel = uipanel(<span class="keyword">...</span>
    h.main,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'axesPanel'</span>,<span class="keyword">...</span>
    <span class="string">'Title'</span>, <span class="string">'Fluorescence Channels'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>, prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Clipping'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'pixels'</span>);

prefs.aO = get(h.axesPanel, <span class="string">'Position'</span>);

<span class="comment">% Load Data Panel</span>
h.controlPanel1 = uipanel(<span class="keyword">...</span>
    h.main,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'AxesPanel'</span>,<span class="keyword">...</span>
    <span class="string">'Title'</span>, <span class="string">'Load Data'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>, prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Clipping'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'pixels'</span>);

<span class="comment">% Automatic selection controls</span>
h.controlPanel2 = uipanel(<span class="keyword">...</span>
    h.main,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'LoadDataPanel'</span>,<span class="keyword">...</span>
    <span class="string">'Title'</span>, <span class="string">'Add. Controls'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>, prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Clipping'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'pixels'</span>);

<span class="comment">% Manual selection overview panel</span>
h.manualPanel = uipanel(<span class="keyword">...</span>
    h.main,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ManualSelectionPanel'</span>,<span class="keyword">...</span>
    <span class="string">'Title'</span>, <span class="string">'Manual Selection (x/y in pixels)'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>, prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Clipping'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'pixels'</span>);

<span class="comment">% Data evaluation panel</span>
h.evalPanel = uipanel(<span class="keyword">...</span>
    h.main,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ManualSelectionPanel'</span>,<span class="keyword">...</span>
    <span class="string">'Title'</span>, <span class="string">'Trace analysis'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>, prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Clipping'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'pixels'</span>);
</pre><img vspace="5" hspace="5" src="GUImain_02.png" alt=""> <pre class="codeinput"><span class="comment">%%	Axes/Images</span>
<span class="comment">% Main Axes</span>
h.ax1 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.axesPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'AmbientLightColor'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,256],<span class="string">'YLim'</span>,[1,512],<span class="keyword">...</span>
    <span class="string">'Tag'</span>,<span class="string">'ax1'</span>,<span class="keyword">...</span>
    <span class="string">'ButtonDownFcn'</span>, @ax_ButtonDownFcn,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

h.ax2 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.axesPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,256],<span class="string">'YLim'</span>,[1,512],<span class="keyword">...</span>
    <span class="string">'HitTest'</span>,<span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>,<span class="string">'ax2'</span>,<span class="keyword">...</span>
    <span class="string">'ButtonDownFcn'</span>, @ax_ButtonDownFcn,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

h.ax3 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.axesPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,256],<span class="string">'YLim'</span>,[1,512],<span class="keyword">...</span>
    <span class="string">'HitTest'</span>,<span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>,<span class="string">'ax3'</span>,<span class="keyword">...</span>
    <span class="string">'ButtonDownFcn'</span>, @ax_ButtonDownFcn,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

h.ax4 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.axesPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,256],<span class="string">'YLim'</span>,[1,512],<span class="keyword">...</span>
    <span class="string">'HitTest'</span>,<span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>,<span class="string">'ax4'</span>,<span class="keyword">...</span>
    <span class="string">'ButtonDownFcn'</span>, @ax_ButtonDownFcn,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

<span class="comment">% Zoom Axes</span>
h.zax1 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.manualPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,prefs.z*2+1],<span class="string">'YLim'</span>,[1,prefs.z*2+1],<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'zax1'</span>,<span class="keyword">...</span>
    <span class="string">'box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

h.zax2 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.manualPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,prefs.z*2+1],<span class="string">'YLim'</span>,[1,prefs.z*2+1],<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'zax2'</span>,<span class="keyword">...</span>
    <span class="string">'box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

h.zax3 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.manualPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,prefs.z*2+1],<span class="string">'YLim'</span>,[1,prefs.z*2+1],<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'zax3'</span>,<span class="keyword">...</span>
    <span class="string">'box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

h.zax4 = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.manualPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>,prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'YDir'</span>, <span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'XLim'</span>,[1,prefs.z*2+1],<span class="string">'YLim'</span>,[1,prefs.z*2+1],<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'zax4'</span>,<span class="keyword">...</span>
    <span class="string">'box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'off'</span>);

<span class="comment">% Trace Plot Axes</span>

h.trax = axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>,h.evalPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>, prefs.AxesColor,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'trax'</span>,<span class="keyword">...</span>
    <span class="string">'box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>,<span class="keyword">...</span>
    <span class="string">'Visible'</span>,<span class="string">'on'</span>);
</pre><img vspace="5" hspace="5" src="GUImain_03.png" alt=""> <h2>UI Tables<a name="6"></a></h2><pre class="codeinput">h.tXY = uitable(<span class="keyword">...</span>
    h.evalPanel,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'XYtable'</span>,<span class="keyword">...</span>
    <span class="string">'ColumnName'</span>,prefs.lbx,<span class="keyword">...</span><span class="comment">                      % set col titles</span>
    <span class="string">'ColumnFormat'</span>, {<span class="string">'numeric'</span>},<span class="keyword">...</span>
    <span class="string">'ColumnWidth'</span>,{70});                <span class="comment">% set all col widths at once);</span>
</pre><img vspace="5" hspace="5" src="GUImain_04.png" alt=""> <pre class="codeinput"><span class="comment">%%	Sliders</span>

h.sldPlay = uicontrol(<span class="keyword">...</span>
    h.axesPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'sldPlay'</span>, <span class="keyword">...</span>
    <span class="string">'Style'</span>,<span class="string">'slider'</span>,<span class="keyword">...</span><span class="comment">%     'Position', [30,prefs.AxesOffset(1,2)-32, 4*256, 30],...</span>
    <span class="string">'Value'</span>,1,<span class="keyword">...</span>
    <span class="string">'Min'</span>,1,<span class="string">'Max'</span>,2,<span class="keyword">...</span>
    <span class="string">'SliderStep'</span>,[1,1],<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @sldPlay_move,<span class="keyword">...</span>
    <span class="string">'Visible'</span>, <span class="string">'off'</span>);
</pre><img vspace="5" hspace="5" src="GUImain_05.png" alt=""> <pre class="codeinput"><span class="comment">%%	Control Buttons</span>

h.cbn_load1 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_load1'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load 1st channel'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoad);

h.cbn_load2 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_load2'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load 2nd channel'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoad);

h.cbn_load3 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_load3'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load 3rd channel'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoad);

h.cbn_load4 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_load4'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load 4th channel'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoad);

h.cbn_cam1 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_cam1'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load 1st camera (ch1/ch2)'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoad_dual);

h.cbn_cam2 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_cam2'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load 2nd camera (ch3/ch4)'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoad_dual);

h.cbn_calibrate = uicontrol(<span class="keyword">...</span>
    h.controlPanel2,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_cal'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Generate Map'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnCal);

h.cbn_loadmap = uicontrol(<span class="keyword">...</span>
    h.controlPanel2,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbn_loadmap'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Load Map'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbnLoadMap);
</pre><img vspace="5" hspace="5" src="GUImain_06.png" alt=""> <pre class="codeinput"><span class="comment">%%	Check Boxes</span>

h.ckx_load1 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_load1'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0);

h.ckx_load2 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_load2'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0);

h.ckx_load3 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_load3'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0);

h.ckx_load4 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_load4'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0);

h.ckx_flip1 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_flip1'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0);

h.ckx_flip2 = uicontrol(<span class="keyword">...</span>
    h.controlPanel1,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_flip2'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @flipCh);

h.ckx_cal = uicontrol(<span class="keyword">...</span>
    h.controlPanel2,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'ckx_cal'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>,0);
</pre><img vspace="5" hspace="5" src="GUImain_07.png" alt=""> <h2>Popup Menus (Comboboxes)<a name="10"></a></h2><pre class="codeinput">h.cbx_alex = uicontrol(<span class="keyword">...</span>
    h.controlPanel2,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbx_alex'</span>, <span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, {<span class="string">'ALEX Seq.'</span>,<span class="string">'2 Exc.'</span>,<span class="string">'3 Exc.'</span>,<span class="string">'4 Exc.'</span>,<span class="string">'5 Exc.'</span>},<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbx_alex_change);

h.cbx_alexCurrent = uicontrol(<span class="keyword">...</span>
    h.controlPanel2,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'cbx_alexCurrent'</span>, <span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, {<span class="string">'No ALEX'</span>},<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>,prefs.BackColor,<span class="keyword">...</span>
    <span class="string">'ForegroundColor'</span>,prefs.ForeColor,<span class="keyword">...</span>
    <span class="string">'Enable'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @cbx_alexCurrent_change);
</pre><img vspace="5" hspace="5" src="GUImain_08.png" alt=""> <h2>Variables, Handles and Window Positions<a name="11"></a></h2><pre class="codeinput">h.refax = [h.ax1,h.ax2,h.ax3,h.ax4];
h.refzax = [h.zax1,h.zax2,h.zax3,h.zax4];
h.boxes = [h.ckx_load1,h.ckx_load2,h.ckx_load3,h.ckx_load4];
[res,img] = deal({});                                     <span class="comment">% introduce res and img as cell arrays</span>
[res{1:4}] = deal({});                                    <span class="comment">% assign res array</span>
[img{1:4}] = deal({});                                    <span class="comment">% assign img array</span>
set(h.main, <span class="string">'WindowButtonMotionFcn'</span>, @WindowButtonMotionFcn, <span class="string">'ResizeFcn'</span>,@main_resize);
main_resize();
</pre><img vspace="5" hspace="5" src="GUImain_09.png" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><h2>CALLBACK FUNCTIONS<a name="13"></a></h2><div><ul><li>GUI Resize Function</li><li>Slider Callbacks</li><li>Button Callbacks</li><li>MouseMove Callback</li><li>ButtonDown Callbacks</li></ul></div><h2>Main GUI Callbacks<a name="14"></a></h2><pre class="codeinput"><span class="keyword">function</span> main_resize(~, ~, ~)
<span class="comment">% defines all UI control positions and adjusts on window resize</span>

<span class="keyword">global</span> h prefs;
prefs.WS = get(h.main,<span class="string">'Position'</span>); <span class="comment">% get window size</span>

<span class="comment">% try</span>
<span class="comment">% Panels</span>
set(h.axesPanel,<span class="string">'Position'</span>, [prefs.UIs,prefs.WS(1,4)-prefs.APH-prefs.UIs,prefs.UIs * 2 + prefs.APW * 4, prefs.APH]); <span class="comment">% W: prefs.WS(1,3)-prefs.UIs * 2</span>
set(h.controlPanel1, <span class="string">'Position'</span>, [prefs.UIs,prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH,prefs.CPW, prefs.CPH]);
set(h.controlPanel2, <span class="string">'Position'</span>, [prefs.UIs * 2 + getfield(get(h.controlPanel1,<span class="string">'Position'</span>),{1,3}),prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH,prefs.CPW, prefs.CPH]);
set(h.manualPanel, <span class="string">'Position'</span>, [prefs.UIs * 3 + prefs.CPW + getfield(get(h.controlPanel2,<span class="string">'Position'</span>),{1,3}),prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH,getfield(get(h.axesPanel,<span class="string">'Position'</span>),{1,3})- 2 * prefs.CPW - 2 * prefs.UIs, prefs.CPH]); <span class="comment">% W: prefs.UIs * 4 - prefs.CPW * 2</span>
set(h.evalPanel, <span class="string">'Position'</span>, [prefs.UIs * 2 + getfield(get(h.axesPanel,<span class="string">'Position'</span>),{1,3}),prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH, prefs.WS(1,3) - prefs.UIs * 5 - prefs.APW * 4, prefs.CPH + prefs.APH + prefs.UIs]);

<span class="comment">% Axes</span>
set(h.ax1, <span class="string">'Position'</span>, prefs.AxesOffset);
set(h.ax2, <span class="string">'Position'</span>, prefs.AxesOffset + 1 * [prefs.AxesOffset(1,3),0,0,0]);
set(h.ax3, <span class="string">'Position'</span>, prefs.AxesOffset + 2 * [prefs.AxesOffset(1,3),0,0,0]);
set(h.ax4, <span class="string">'Position'</span>, prefs.AxesOffset + 3 * [prefs.AxesOffset(1,3),0,0,0]);

set(h.zax1, <span class="string">'Position'</span>, [prefs.UIs * 2,prefs.CPH - prefs.UIs * 1.5 - prefs.zAP, prefs.zAP, prefs.zAP]);
set(h.zax2, <span class="string">'Position'</span>, [prefs.UIs * 4 + prefs.zAP,prefs.CPH - prefs.UIs * 1.5 - prefs.zAP, prefs.zAP, prefs.zAP]);
set(h.zax3, <span class="string">'Position'</span>, [prefs.UIs * 2,prefs.CPH - prefs.UIs * 2.5 - prefs.zAP * 2, prefs.zAP, prefs.zAP]);
set(h.zax4, <span class="string">'Position'</span>, [prefs.UIs * 4 + prefs.zAP,prefs.CPH - prefs.UIs * 2.5 - prefs.zAP * 2, prefs.zAP, prefs.zAP]);

set(h.trax, <span class="string">'Position'</span>, [prefs.UIs * 2,prefs.CPH  + prefs.UIs * 4,getfield(get(h.evalPanel,<span class="string">'Position'</span>),{1,3}) - 4 * prefs.UIs,512]);

<span class="comment">% Listboxes</span>
set(h.tXY, <span class="string">'Position'</span>, [prefs.UIs * 2,prefs.UIs,getfield(get(h.evalPanel,<span class="string">'Position'</span>),{1,3}) - 4 * prefs.UIs,256]);
<span class="comment">% Sliders</span>
set(h.sldPlay, <span class="string">'Position'</span>, [prefs.UIs,prefs.AxesOffset(1,2)-32, 4*256, 30]);

<span class="comment">% Buttons</span>
set(h.cbn_load1, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH- prefs.UIs * 1.5 - prefs.cbH,prefs.cbW,prefs.cbH]);
set(h.cbn_load2, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 2.5 - prefs.cbH * 2,prefs.cbW,prefs.cbH]);
set(h.cbn_load3, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 3.5 - prefs.cbH * 3,prefs.cbW,prefs.cbH]);
set(h.cbn_load4, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 4.5 - prefs.cbH * 4,prefs.cbW,prefs.cbH]);
set(h.cbn_cam1, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 5.5 - prefs.cbH * 5,prefs.cbW,prefs.cbH]);
set(h.cbn_cam2, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 6.5 - prefs.cbH * 6,prefs.cbW,prefs.cbH]);


set(h.cbn_calibrate, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 1.5 - prefs.cbH,prefs.cbW,prefs.cbH]);
set(h.cbn_loadmap, <span class="string">'Position'</span>,[prefs.UIs,prefs.CPH - prefs.UIs * 2.5 - prefs.cbH * 2,prefs.cbW,prefs.cbH]);

<span class="comment">% Check Boxes</span>
set(h.ckx_load1,<span class="string">'Position'</span>,[prefs.UIs * 2 + prefs.cbW,prefs.CPH - prefs.UIs * 1.5 - prefs.cbH,prefs.ckW,prefs.ckH]);
set(h.ckx_load2,<span class="string">'Position'</span>,[prefs.UIs * 2 + prefs.cbW,prefs.CPH  - prefs.UIs * 2.5 - prefs.cbH * 2,prefs.ckW,prefs.ckH]);
set(h.ckx_load3,<span class="string">'Position'</span>,[prefs.UIs * 2 + prefs.cbW,prefs.CPH  - prefs.UIs * 3.5 - prefs.cbH * 3,prefs.ckW,prefs.ckH]);
set(h.ckx_load4,<span class="string">'Position'</span>,[prefs.UIs * 2 + prefs.cbW,prefs.CPH  - prefs.UIs * 4.5 - prefs.cbH * 4,prefs.ckW,prefs.ckH]);

set(h.ckx_cal,<span class="string">'Position'</span>,[prefs.UIs * 2 + prefs.cbW,prefs.CPH - prefs.UIs * 2.5 - prefs.cbH * 1.5,prefs.ckW,prefs.ckH]);

<span class="comment">% Popupmenus (Combo Boxes)</span>

set(h.cbx_alex, <span class="string">'Position'</span>, [prefs.UIs,prefs.CPH - prefs.UIs * 3.5 - prefs.cbH * 3,prefs.cbW,prefs.cbH]);
set(h.cbx_alexCurrent, <span class="string">'Position'</span>, [prefs.UIs,prefs.CPH - prefs.UIs * 4.5 - prefs.cbH * 4,prefs.cbW,prefs.cbH]);

prefs.aO = get(h.axesPanel, <span class="string">'Position'</span>); <span class="comment">% axesOffset</span>
<span class="comment">% Captions</span>

<span class="comment">% catch</span>
<span class="comment">%     disp('ResizeFcn: Error occured');</span>
<span class="comment">% end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> main_close(hObj, ~, ~)
<span class="comment">%   Close Main window and clear memory</span>
<span class="keyword">global</span> h;
delete(hObj);
<span class="keyword">try</span>
    delete(h.main);
<span class="keyword">catch</span>

<span class="keyword">end</span>
    clear <span class="string">all</span>;
    close <span class="string">all</span> <span class="string">force</span>;
<span class="keyword">end</span>
</pre><h2>Checkbox Callbacks<a name="15"></a></h2><pre class="codeinput"><span class="keyword">function</span> flipCh(hObj, ~, ~)
<span class="keyword">global</span> h img;
n = get(hObj, <span class="string">'Tag'</span>); n = str2num(n(end));
img{n}.raw = fliplr(img{n}.raw);
updateGUI();
<span class="keyword">end</span>
</pre><h2>Button Callbacks<a name="16"></a></h2><pre class="codeinput"><span class="keyword">function</span> cbnLoad(hObj, ~, ~)
<span class="keyword">global</span> h img res;
chan = get(hObj, <span class="string">'Tag'</span>);
<span class="comment">% try</span>
[filename,filepath] = uigetfile(<span class="string">'*.tif;*.tiff'</span>,<span class="string">'TIF Images'</span>);
fullpath = [filepath,filename];
<span class="keyword">if</span> ~filename
    <span class="keyword">return</span>;
<span class="keyword">end</span>
[tif,~] = openTIF(fullpath);
chan = str2double(chan(end));
img{chan}.raw = tif;
<span class="comment">% res{chan} = {};</span>
res{chan}.click = 0;
set(h.sldPlay, <span class="string">'Min'</span>,1, <span class="string">'Max'</span>, size(tif,3), <span class="string">'SliderStep'</span>, [1,5]/(size(tif,3)-1), <span class="string">'Value'</span>, 1, <span class="string">'Visible'</span>, <span class="string">'on'</span>);
sldPlay_move(1);
set(h.([<span class="string">'ckx_load'</span>,num2str(chan)]), <span class="string">'Value'</span>, true);
<span class="comment">% catch</span>
<span class="comment">%     set(h.ckx_load1, 'Value', 0);set(h.ckx_load2, 'Value', 0);%set(h.ckx_load3, 'Value', 0);set(h.ckx_load4, 'Value', 0);</span>
<span class="comment">%     disp('cbnLoad: Error occured.');</span>
<span class="comment">% end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> cbnLoad_dual(hObj, ~, ~)
<span class="keyword">global</span> h img res;
<span class="comment">% try</span>
chan = get(hObj, <span class="string">'Tag'</span>);
[filename,filepath] = uigetfile(<span class="string">'*.tif;*.tiff'</span>,<span class="string">'TIF Images'</span>);
fullpath = [filepath,filename];
<span class="keyword">if</span> ~filename                            <span class="comment">% exit function, if filename is empty</span>
    <span class="keyword">return</span>;
<span class="keyword">end</span>
chan = str2double(chan(end));
[tif,~] = openTIF(fullpath);

[img{chan * 2 - 1}.raw, img{chan * 2}.raw] = deal(tif(:,1:floor(end/2),:),tif(:,floor(end/2)+1:end,:));
[res{chan * 2 - 1}.click,res{chan*2}.click]  = deal(1);

set(h.sldPlay, <span class="string">'Min'</span>,1, <span class="string">'Max'</span>, size(tif,3), <span class="string">'SliderStep'</span>, [1,5]/(size(tif,3)-1), <span class="string">'Value'</span>, 1, <span class="string">'Visible'</span>, <span class="string">'on'</span>);
sldPlay_move(1);
set(h.ckx_load1, <span class="string">'Value'</span>, 1)
<span class="comment">% catch</span>
<span class="comment">%     set(h.ckx_load1, 'Value', 0)</span>
<span class="comment">%     disp('cbnLoad_dual: Error occured.');</span>
<span class="comment">% % end</span>
<span class="keyword">end</span>


<span class="keyword">function</span> cbnCal(~, ~, ~)
</pre><pre class="codeinput"><span class="comment">%</span>
<span class="comment">% starts mapping procedure (particle detection in multiple channels)</span>
<span class="comment">%</span>
</pre><h2>generate totalimg &amp; cancel noise<a name="18"></a></h2><pre class="codeinput"><span class="keyword">global</span> h img1 img2;
<span class="keyword">if</span> get(h.ckx_load1, <span class="string">'Value'</span>) == 1 &amp;&amp; get(h.ckx_load2, <span class="string">'Value'</span>) == 1
    tifs = size(img1,3);
    [imgL1, imgR1, imgL2, imgR2] = deal(double(zeros(size(img1,1),size(img1,2)/2)));
    <span class="keyword">for</span> frame = 1:tifs
        imgL1 = imgL1 + double(img1(1:end,1:end/2,frame)/tifs);
        imgR1 = imgR1 + double(img1(1:end,end/2+1:end,frame)/tifs);
        imgL2 = imgL2 + double(img2(1:end,1:end/2,frame)/tifs);
        imgR2 = imgR2 + double(img2(1:end,end/2+1:end,frame)/tifs);
    <span class="keyword">end</span>
    img1(:,:,tifs + 1) = [imgL1,imgR1];
    img2(:,:,tifs + 1) = [imgL2,imgR2];
    set(h.sldPlay, <span class="string">'Max'</span>, tifs + 1,<span class="string">'Value'</span>, tifs + 1);
    sldPlay_move(h.sldPlay,[]);
<span class="keyword">end</span>
</pre><h2>perform particle recognition<a name="19"></a></h2><pre class="codeinput">disp(<span class="string">'Command line ready'</span>);
</pre><pre class="codeinput"><span class="keyword">end</span>

<span class="keyword">function</span> cbnLoadMap(~, ~, ~)

<span class="keyword">end</span>
</pre><h2>Slider Callbacks<a name="21"></a></h2><pre class="codeinput"><span class="keyword">function</span> sldPlay_move(~, ~, ~)
<span class="keyword">global</span> h img res prefs;
prefs.currentframe = round(get(h.sldPlay, <span class="string">'Value'</span>));
updateGUI(); <span class="comment">% redraw GUI with images</span>

<span class="keyword">end</span>
</pre><h2>MouseMove and ButtonDown Callbacks<a name="22"></a></h2><pre class="codeinput"><span class="keyword">function</span> ax_ButtonDownFcn(hObj, ~, ~)
<span class="comment">% processes mouse button down events</span>
<span class="keyword">global</span> h img prefs res;
h.caller = get(hObj, <span class="string">'Parent'</span>);
c = find(h.caller==h.refax);
<span class="keyword">switch</span> get(gcbf, <span class="string">'SelectionType'</span>)
    <span class="keyword">case</span> <span class="string">'normal'</span>
        <span class="keyword">if</span> ~isfield(img{c}, <span class="string">'raw'</span>)
            <span class="keyword">return</span>;
        <span class="keyword">end</span>
        <span class="comment">% Left click: fixate zoom preview and set imgsel as pciture</span>
        <span class="keyword">if</span> ~isfield(res{c},<span class="string">'click'</span>)
           res{c}.click = 1;
        <span class="keyword">else</span>
            res{c}.click = ~res{c}.click;
        <span class="keyword">end</span>

        <span class="keyword">if</span> res{c}.click

            XY = floor(res{c}.lastpos);
            res{c}.sel{end + 1}.h = rectangle( <span class="string">'Parent'</span>, h.caller, <span class="keyword">...</span>
                <span class="string">'Curvature'</span>, [1,1], <span class="keyword">...</span>
                <span class="string">'Position'</span>, [XY(1,1:2) - prefs.z,prefs.z * 2 + 1,prefs.z * 2 + 1], <span class="keyword">...</span>
                <span class="string">'EdgeColor'</span>,prefs.colors{c},<span class="keyword">...</span>
                <span class="string">'ButtonDownFcn'</span>, @Click_DeleteMe);
             <span class="comment">% label rectangle with particle number</span>

            <span class="keyword">if</span> ~isfield(res{c},<span class="string">'trace'</span>)
                res{c}.trace = {};
            <span class="keyword">end</span>
             <span class="keyword">if</span> ~isfield(res{c},<span class="string">'XY'</span>)
                    res{c}.XY = {};
             <span class="keyword">end</span>
                res{c}.XY{end + 1} = res{c}.lastpos;
                 res{c}.sel{end}.lbl = text(XY(1,1), XY(1,2), num2str(size(res{c}.XY,2),<span class="string">'%d'</span>), <span class="string">'horizontal'</span>,<span class="string">'left'</span>, <span class="string">'vertical'</span>,<span class="string">'bottom'</span>,<span class="string">'Color'</span>,prefs.colors{c},<span class="string">'HitTest'</span>, <span class="string">'off'</span>, <span class="string">'FontSize'</span>, 12);
                extractTrace(c); <span class="comment">% extract trace</span>

                plotTrace(c);   <span class="comment">% plot trace in trace axes...</span>

        <span class="keyword">end</span>
    <span class="keyword">case</span> <span class="string">'alt'</span>

<span class="keyword">end</span>


<span class="keyword">end</span>

<span class="keyword">function</span> WindowButtonMotionFcn(~, ~, ~)
<span class="comment">% processes mouse move events</span>
<span class="keyword">global</span> h prefs res img;
prefs.mouseXY = uint16((get(gcbf,<span class="string">'CurrentPoint'</span>)));
<span class="keyword">for</span> i=1:size(res,2)
    <span class="keyword">if</span> ~isfield(img{i}, <span class="string">'raw'</span>)
        <span class="keyword">return</span>;
    <span class="keyword">end</span>
    axpan = get(h.refax(i),<span class="string">'Position'</span>) + [prefs.aO(1,1:2),0,0]; <span class="comment">%</span>

    <span class="keyword">if</span> min(prefs.mouseXY &gt;= axpan(1,1:2)) &amp;&amp; min(prefs.mouseXY &lt;= (axpan(1,1:2) + axpan(1,3:4))) <span class="comment">% check over which axes the cursor hovers...</span>
        tmp = floor(get(h.refax(i), <span class="string">'CurrentPoint'</span>));
        res{i}.lastpos = tmp;

        <span class="keyword">if</span> ~isfield(res{i}, <span class="string">'sel'</span>)                                          <span class="comment">% check for sel field and create if necessary</span>
               res{i}.sel = {};
        <span class="keyword">end</span>

        prefs.uitable(size(res{i}.sel,2) + 1, (i*2-1):i*2) = tmp(1,1:2);
        set(h.tXY, <span class="string">'Data'</span>, prefs.uitable)                                   <span class="comment">% enter XY data into uitable</span>

        set(h.refzax(i),<span class="keyword">...</span><span class="comment">                                                 % set 'zoomed' ROI in zoom axes</span>
            <span class="string">'Visible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
            <span class="string">'YLim'</span>, tmp(1,2) + prefs.z * [-1,1] ,<span class="keyword">...</span>
            <span class="string">'XLim'</span>, tmp(1,1) + prefs.z * [-1,1]);


    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>Listbox Function<a name="23"></a></h2><pre class="codeinput"><span class="keyword">function</span> Click_DeleteMe(hObj,~,~)
<span class="keyword">global</span> res;
<span class="comment">% deletes manual selection marker and label on click</span>
res{c}.sel(end) = [];
<span class="keyword">end</span>

<span class="keyword">function</span> UpdateUItable()
<span class="keyword">global</span> res h;


<span class="keyword">end</span>

<span class="keyword">function</span> prePlot()
<span class="keyword">global</span> h res prefs;
set(h.trax, <span class="string">'Children'</span>, []);
<span class="keyword">for</span> i=1:4
   prefs.plot{i} = plot(h.trax, [1:size(res{i}.trace{end},2)], zeros([1,size(res{i}.trace{end},2)]),<span class="string">'Color'</span>, prefs.colors{c});
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>ALEX Callback<a name="24"></a></h2><pre class="codeinput"><span class="keyword">function</span> cbx_alex_change(hObj,~,~)
<span class="comment">% evaluates ALEX popup menu selection</span>
<span class="keyword">global</span> h prefs;
prefs.ALEX = get(hObj, <span class="string">'Value'</span>);
alexString = {};
<span class="comment">% fill ALEX channel select popup menu</span>
<span class="keyword">switch</span> prefs.ALEX
    <span class="keyword">case</span> 1
        alexString{end + 1} = <span class="string">'No ALEX'</span>;
        set(h.cbx_alexCurrent, <span class="string">'Enable'</span>, <span class="string">'off'</span>);
    <span class="keyword">otherwise</span>
        <span class="keyword">for</span> i = 1:prefs.ALEX
            alexString{end+1} = [num2str(i),<span class="string">'st. Ex.'</span>];
        <span class="keyword">end</span>
        set(h.cbx_alexCurrent, <span class="string">'Enable'</span>, <span class="string">'on'</span>);
<span class="keyword">end</span>
prefs.ALEXcurrent = 1;
set(h.cbx_alexCurrent, <span class="string">'String'</span>, alexString);
<span class="comment">% refresh GUI and recalculate FRET traces...</span>

<span class="keyword">end</span>

<span class="keyword">function</span> cbx_alexCurrent_change(hObj,~,~)
<span class="comment">% currently selected ALEX channel to show</span>
<span class="keyword">global</span> prefs;
prefs.ALEXcurrent = get(hObj, <span class="string">'Value'</span>);
<span class="keyword">end</span>
</pre><h2>Other GUI functions<a name="25"></a></h2><pre class="codeinput"><span class="keyword">function</span> updateGUI()
<span class="comment">% refreshes GUI</span>
<span class="keyword">global</span> h img prefs;
<span class="keyword">for</span> i = 1:4
    <span class="keyword">if</span> isfield(img{i},<span class="string">'raw'</span>)
        tif = img{i}.raw;
        <span class="comment">%try</span>
            h.g(i) = imshow(tif(:,:,prefs.currentframe), <span class="string">'Parent'</span>, h.refax(i), <span class="string">'DisplayRange'</span>, [min(min(tif(:,:,prefs.currentframe))),max(max(tif(:,:,prefs.currentframe)))], <span class="string">'Colormap'</span>, colormap(gray));
            imshow(tif(:,:,prefs.currentframe), <span class="string">'Parent'</span>, h.refzax(i), <span class="string">'DisplayRange'</span>, [min(min(tif(:,:,prefs.currentframe))),max(max(tif(:,:,prefs.currentframe)))], <span class="string">'Colormap'</span>, colormap(gray));
            res{i}.click = 0;
            set(h.boxes(i), <span class="string">'Value'</span>, 1)
            set(h.refzax(i),<span class="string">'Visible'</span>, <span class="string">'on'</span>);
            set(h.g(i), <span class="string">'ButtonDownFcn'</span>,@ax_ButtonDownFcn, <span class="string">'Tag'</span>, strcat(<span class="string">'tifax'</span>,num2str(i)), <span class="string">'HitTest'</span>, <span class="string">'on'</span>);
        <span class="comment">%catch</span>
        <span class="comment">%end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%%  TRacer Main GUI v0.1
%
%   generates main figure
%

function GUImain()
global h prefs res img;

%% Main Figure
set(0, 'defaultAxesXColor', 'w',...
    'defaultAxesYColor', 'w');

h.main = figure(...
    'Name', 'TRACER: Main Experiment Window',...
    'NumberTitle','off',...
    'units', 'normalized', ...
    'OuterPosition', [0 0 1 1],... 
    'units','pixels',...
    'Color', prefs.BackColor,...
    'CloseRequestFcn', @main_close,...
    'MenuBar', 'none',...
    'Toolbar', 'none');

prefs.WS = get(h.main, 'Position');  
set(h.main, 'Position', prefs.WS + [0,39,0,-40]);  % correct figure for Taskbar height

%%	UI Panels

h.axesPanel = uipanel(...
    h.main,...
    'Tag', 'axesPanel',...
    'Title', 'Fluorescence Channels',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor', prefs.ForeColor,...
    'Clipping', 'on',...
    'Units','pixels');

prefs.aO = get(h.axesPanel, 'Position');

% Load Data Panel
h.controlPanel1 = uipanel(...
    h.main,...
    'Tag', 'AxesPanel',...
    'Title', 'Load Data',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor', prefs.ForeColor,...
    'Clipping', 'on',...
    'Units','pixels');

% Automatic selection controls
h.controlPanel2 = uipanel(...
    h.main,...
    'Tag', 'LoadDataPanel',...
    'Title', 'Add. Controls',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor', prefs.ForeColor,...
    'Clipping', 'on',...
    'Units','pixels');

% Manual selection overview panel
h.manualPanel = uipanel(...
    h.main,...
    'Tag', 'ManualSelectionPanel',...
    'Title', 'Manual Selection (x/y in pixels)',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor', prefs.ForeColor,...
    'Clipping', 'on',...
    'Units','pixels');

% Data evaluation panel
h.evalPanel = uipanel(...
    h.main,...
    'Tag', 'ManualSelectionPanel',...
    'Title', 'Trace analysis',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor', prefs.ForeColor,...
    'Clipping', 'on',...
    'Units','pixels');

%%	Axes/Images
% Main Axes
h.ax1 = axes(...
    'Parent',h.axesPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'AmbientLightColor',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,256],'YLim',[1,512],...
    'Tag','ax1',...
    'ButtonDownFcn', @ax_ButtonDownFcn,...
    'NextPlot', 'add',...
    'Visible','off');

h.ax2 = axes(...
    'Parent',h.axesPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,256],'YLim',[1,512],...
    'HitTest','on',...
    'Tag','ax2',...
    'ButtonDownFcn', @ax_ButtonDownFcn,...
    'NextPlot', 'add',...
    'Visible','off');

h.ax3 = axes(...
    'Parent',h.axesPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,256],'YLim',[1,512],...
    'HitTest','on',...
    'Tag','ax3',...
    'ButtonDownFcn', @ax_ButtonDownFcn,...
    'NextPlot', 'add',...
    'Visible','off');

h.ax4 = axes(...
    'Parent',h.axesPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,256],'YLim',[1,512],...
    'HitTest','on',...
    'Tag','ax4',...
    'ButtonDownFcn', @ax_ButtonDownFcn,...
    'NextPlot', 'add',...
    'Visible','off');

% Zoom Axes
h.zax1 = axes(...
    'Parent',h.manualPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,prefs.z*2+1],'YLim',[1,prefs.z*2+1],...
    'Tag', 'zax1',...
    'box', 'on',...
    'Visible','off');

h.zax2 = axes(...
    'Parent',h.manualPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,prefs.z*2+1],'YLim',[1,prefs.z*2+1],...
    'Tag', 'zax2',...
    'box', 'on',...
    'Visible','off');

h.zax3 = axes(...
    'Parent',h.manualPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,prefs.z*2+1],'YLim',[1,prefs.z*2+1],...
    'Tag', 'zax3',...
    'box', 'on',...
    'Visible','off');

h.zax4 = axes(...
    'Parent',h.manualPanel,...
    'units','pixels',...
    'Color',prefs.AxesColor,...
    'YDir', 'reverse',...
    'XLim',[1,prefs.z*2+1],'YLim',[1,prefs.z*2+1],...
    'Tag', 'zax4',...
    'box', 'on',...
    'Visible','off');

% Trace Plot Axes

h.trax = axes(...
    'Parent',h.evalPanel,...
    'units','pixels',...
    'Color', prefs.AxesColor,...
    'Tag', 'trax',...
    'box', 'on',...
    'NextPlot', 'add',...
    'Visible','on');
%%  UI Tables

h.tXY = uitable(...
    h.evalPanel,...
    'units','pixels',...
    'Tag', 'XYtable',...
    'ColumnName',prefs.lbx,...                      % set col titles
    'ColumnFormat', {'numeric'},...
    'ColumnWidth',{70});                % set all col widths at once);
    
%%	Sliders

h.sldPlay = uicontrol(...
    h.axesPanel,...
    'Tag', 'sldPlay', ...
    'Style','slider',...%     'Position', [30,prefs.AxesOffset(1,2)-32, 4*256, 30],...
    'Value',1,...
    'Min',1,'Max',2,...
    'SliderStep',[1,1],...
    'Callback', @sldPlay_move,...
    'Visible', 'off');

%%	Control Buttons

h.cbn_load1 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'cbn_load1',...
    'Style', 'pushbutton',...
    'String', 'Load 1st channel',...
    'Callback', @cbnLoad);

h.cbn_load2 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'cbn_load2',...
    'Style', 'pushbutton',...
    'String', 'Load 2nd channel',...
    'Callback', @cbnLoad);

h.cbn_load3 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'cbn_load3',...
    'Style', 'pushbutton',...
    'String', 'Load 3rd channel',...
    'Callback', @cbnLoad);

h.cbn_load4 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'cbn_load4',...
    'Style', 'pushbutton',...
    'String', 'Load 4th channel',...
    'Callback', @cbnLoad);

h.cbn_cam1 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'cbn_cam1',...
    'Style', 'pushbutton',...
    'String', 'Load 1st camera (ch1/ch2)',...
    'Callback', @cbnLoad_dual);

h.cbn_cam2 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'cbn_cam2',...
    'Style', 'pushbutton',...
    'String', 'Load 2nd camera (ch3/ch4)',...
    'Callback', @cbnLoad_dual);

h.cbn_calibrate = uicontrol(...
    h.controlPanel2,...
    'Tag', 'cbn_cal',...
    'Style', 'pushbutton',...
    'String', 'Generate Map',...
    'Callback', @cbnCal);

h.cbn_loadmap = uicontrol(...
    h.controlPanel2,...
    'Tag', 'cbn_loadmap',...
    'Style', 'pushbutton',...
    'String', 'Load Map',...
    'Callback', @cbnLoadMap);

%%	Check Boxes

h.ckx_load1 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'ckx_load1',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0);

h.ckx_load2 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'ckx_load2',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0);

h.ckx_load3 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'ckx_load3',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0);

h.ckx_load4 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'ckx_load4',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0);

h.ckx_flip1 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'ckx_flip1',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0);

h.ckx_flip2 = uicontrol(...
    h.controlPanel1,...
    'Tag', 'ckx_flip2',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0,...
    'Callback', @flipCh);

h.ckx_cal = uicontrol(...
    h.controlPanel2,...
    'Tag', 'ckx_cal',...
    'Style', 'checkbox',...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable','off',...
    'Value',0);
%% Popup Menus (Comboboxes)

h.cbx_alex = uicontrol(...
    h.controlPanel2,...
    'Tag', 'cbx_alex', ...
    'Style', 'popupmenu',...
    'String', {'ALEX Seq.','2 Exc.','3 Exc.','4 Exc.','5 Exc.'},...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Callback', @cbx_alex_change);

h.cbx_alexCurrent = uicontrol(...
    h.controlPanel2,...
    'Tag', 'cbx_alexCurrent', ...
    'Style', 'popupmenu',...
    'String', {'No ALEX'},...
    'BackgroundColor',prefs.BackColor,...
    'ForegroundColor',prefs.ForeColor,...
    'Enable', 'off',...
    'Callback', @cbx_alexCurrent_change);
%% Variables, Handles and Window Positions

h.refax = [h.ax1,h.ax2,h.ax3,h.ax4];
h.refzax = [h.zax1,h.zax2,h.zax3,h.zax4];
h.boxes = [h.ckx_load1,h.ckx_load2,h.ckx_load3,h.ckx_load4];
[res,img] = deal({});                                     % introduce res and img as cell arrays
[res{1:4}] = deal({});                                    % assign res array
[img{1:4}] = deal({});                                    % assign img array
set(h.main, 'WindowButtonMotionFcn', @WindowButtonMotionFcn, 'ResizeFcn',@main_resize);
main_resize();

end

%%  CALLBACK FUNCTIONS
%
% * GUI Resize Function
% * Slider Callbacks
% * Button Callbacks
% * MouseMove Callback
% * ButtonDown Callbacks

%%  Main GUI Callbacks

function main_resize(~, ~, ~)
% defines all UI control positions and adjusts on window resize

global h prefs;
prefs.WS = get(h.main,'Position'); % get window size

% try
% Panels
set(h.axesPanel,'Position', [prefs.UIs,prefs.WS(1,4)-prefs.APH-prefs.UIs,prefs.UIs * 2 + prefs.APW * 4, prefs.APH]); % W: prefs.WS(1,3)-prefs.UIs * 2
set(h.controlPanel1, 'Position', [prefs.UIs,prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH,prefs.CPW, prefs.CPH]);
set(h.controlPanel2, 'Position', [prefs.UIs * 2 + getfield(get(h.controlPanel1,'Position'),{1,3}),prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH,prefs.CPW, prefs.CPH]);
set(h.manualPanel, 'Position', [prefs.UIs * 3 + prefs.CPW + getfield(get(h.controlPanel2,'Position'),{1,3}),prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH,getfield(get(h.axesPanel,'Position'),{1,3})- 2 * prefs.CPW - 2 * prefs.UIs, prefs.CPH]); % W: prefs.UIs * 4 - prefs.CPW * 2
set(h.evalPanel, 'Position', [prefs.UIs * 2 + getfield(get(h.axesPanel,'Position'),{1,3}),prefs.WS(1,4) - prefs.UIs * 2 - prefs.CPH - prefs.APH, prefs.WS(1,3) - prefs.UIs * 5 - prefs.APW * 4, prefs.CPH + prefs.APH + prefs.UIs]);

% Axes
set(h.ax1, 'Position', prefs.AxesOffset);
set(h.ax2, 'Position', prefs.AxesOffset + 1 * [prefs.AxesOffset(1,3),0,0,0]);
set(h.ax3, 'Position', prefs.AxesOffset + 2 * [prefs.AxesOffset(1,3),0,0,0]);
set(h.ax4, 'Position', prefs.AxesOffset + 3 * [prefs.AxesOffset(1,3),0,0,0]);

set(h.zax1, 'Position', [prefs.UIs * 2,prefs.CPH - prefs.UIs * 1.5 - prefs.zAP, prefs.zAP, prefs.zAP]);
set(h.zax2, 'Position', [prefs.UIs * 4 + prefs.zAP,prefs.CPH - prefs.UIs * 1.5 - prefs.zAP, prefs.zAP, prefs.zAP]);
set(h.zax3, 'Position', [prefs.UIs * 2,prefs.CPH - prefs.UIs * 2.5 - prefs.zAP * 2, prefs.zAP, prefs.zAP]);
set(h.zax4, 'Position', [prefs.UIs * 4 + prefs.zAP,prefs.CPH - prefs.UIs * 2.5 - prefs.zAP * 2, prefs.zAP, prefs.zAP]);

set(h.trax, 'Position', [prefs.UIs * 2,prefs.CPH  + prefs.UIs * 4,getfield(get(h.evalPanel,'Position'),{1,3}) - 4 * prefs.UIs,512]);

% Listboxes
set(h.tXY, 'Position', [prefs.UIs * 2,prefs.UIs,getfield(get(h.evalPanel,'Position'),{1,3}) - 4 * prefs.UIs,256]);
% Sliders
set(h.sldPlay, 'Position', [prefs.UIs,prefs.AxesOffset(1,2)-32, 4*256, 30]);

% Buttons
set(h.cbn_load1, 'Position',[prefs.UIs,prefs.CPH- prefs.UIs * 1.5 - prefs.cbH,prefs.cbW,prefs.cbH]);
set(h.cbn_load2, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 2.5 - prefs.cbH * 2,prefs.cbW,prefs.cbH]);
set(h.cbn_load3, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 3.5 - prefs.cbH * 3,prefs.cbW,prefs.cbH]);
set(h.cbn_load4, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 4.5 - prefs.cbH * 4,prefs.cbW,prefs.cbH]);
set(h.cbn_cam1, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 5.5 - prefs.cbH * 5,prefs.cbW,prefs.cbH]);
set(h.cbn_cam2, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 6.5 - prefs.cbH * 6,prefs.cbW,prefs.cbH]);


set(h.cbn_calibrate, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 1.5 - prefs.cbH,prefs.cbW,prefs.cbH]);
set(h.cbn_loadmap, 'Position',[prefs.UIs,prefs.CPH - prefs.UIs * 2.5 - prefs.cbH * 2,prefs.cbW,prefs.cbH]);

% Check Boxes
set(h.ckx_load1,'Position',[prefs.UIs * 2 + prefs.cbW,prefs.CPH - prefs.UIs * 1.5 - prefs.cbH,prefs.ckW,prefs.ckH]);
set(h.ckx_load2,'Position',[prefs.UIs * 2 + prefs.cbW,prefs.CPH  - prefs.UIs * 2.5 - prefs.cbH * 2,prefs.ckW,prefs.ckH]);
set(h.ckx_load3,'Position',[prefs.UIs * 2 + prefs.cbW,prefs.CPH  - prefs.UIs * 3.5 - prefs.cbH * 3,prefs.ckW,prefs.ckH]);
set(h.ckx_load4,'Position',[prefs.UIs * 2 + prefs.cbW,prefs.CPH  - prefs.UIs * 4.5 - prefs.cbH * 4,prefs.ckW,prefs.ckH]);

set(h.ckx_cal,'Position',[prefs.UIs * 2 + prefs.cbW,prefs.CPH - prefs.UIs * 2.5 - prefs.cbH * 1.5,prefs.ckW,prefs.ckH]);

% Popupmenus (Combo Boxes)

set(h.cbx_alex, 'Position', [prefs.UIs,prefs.CPH - prefs.UIs * 3.5 - prefs.cbH * 3,prefs.cbW,prefs.cbH]);
set(h.cbx_alexCurrent, 'Position', [prefs.UIs,prefs.CPH - prefs.UIs * 4.5 - prefs.cbH * 4,prefs.cbW,prefs.cbH]);

prefs.aO = get(h.axesPanel, 'Position'); % axesOffset
% Captions

% catch
%     disp('ResizeFcn: Error occured');
% end
end

function main_close(hObj, ~, ~)
%   Close Main window and clear memory
global h;
delete(hObj);
try
    delete(h.main);
catch

end
    clear all;
    close all force;
end

%% Checkbox Callbacks
function flipCh(hObj, ~, ~)
global h img;
n = get(hObj, 'Tag'); n = str2num(n(end));
img{n}.raw = fliplr(img{n}.raw);
updateGUI();
end


%%  Button Callbacks

function cbnLoad(hObj, ~, ~)
global h img res;
chan = get(hObj, 'Tag');
% try
[filename,filepath] = uigetfile('*.tif;*.tiff','TIF Images');
fullpath = [filepath,filename];
if ~filename
    return;
end
[tif,~] = openTIF(fullpath);
chan = str2double(chan(end));
img{chan}.raw = tif;
% res{chan} = {};
res{chan}.click = 0;
set(h.sldPlay, 'Min',1, 'Max', size(tif,3), 'SliderStep', [1,5]/(size(tif,3)-1), 'Value', 1, 'Visible', 'on');
sldPlay_move(1);
set(h.(['ckx_load',num2str(chan)]), 'Value', true);
% catch
%     set(h.ckx_load1, 'Value', 0);set(h.ckx_load2, 'Value', 0);%set(h.ckx_load3, 'Value', 0);set(h.ckx_load4, 'Value', 0);
%     disp('cbnLoad: Error occured.');
% end
end

function cbnLoad_dual(hObj, ~, ~)
global h img res;
% try
chan = get(hObj, 'Tag');
[filename,filepath] = uigetfile('*.tif;*.tiff','TIF Images');
fullpath = [filepath,filename];
if ~filename                            % exit function, if filename is empty
    return;
end
chan = str2double(chan(end));
[tif,~] = openTIF(fullpath);

[img{chan * 2 - 1}.raw, img{chan * 2}.raw] = deal(tif(:,1:floor(end/2),:),tif(:,floor(end/2)+1:end,:));
[res{chan * 2 - 1}.click,res{chan*2}.click]  = deal(1);

set(h.sldPlay, 'Min',1, 'Max', size(tif,3), 'SliderStep', [1,5]/(size(tif,3)-1), 'Value', 1, 'Visible', 'on');
sldPlay_move(1);
set(h.ckx_load1, 'Value', 1)
% catch
%     set(h.ckx_load1, 'Value', 0)
%     disp('cbnLoad_dual: Error occured.');
% % end
end


function cbnCal(~, ~, ~)
%
% starts mapping procedure (particle detection in multiple channels)
%
%%  generate totalimg & cancel noise
global h img1 img2;
if get(h.ckx_load1, 'Value') == 1 && get(h.ckx_load2, 'Value') == 1
    tifs = size(img1,3);
    [imgL1, imgR1, imgL2, imgR2] = deal(double(zeros(size(img1,1),size(img1,2)/2)));
    for frame = 1:tifs
        imgL1 = imgL1 + double(img1(1:end,1:end/2,frame)/tifs);
        imgR1 = imgR1 + double(img1(1:end,end/2+1:end,frame)/tifs);
        imgL2 = imgL2 + double(img2(1:end,1:end/2,frame)/tifs);
        imgR2 = imgR2 + double(img2(1:end,end/2+1:end,frame)/tifs);
    end
    img1(:,:,tifs + 1) = [imgL1,imgR1];
    img2(:,:,tifs + 1) = [imgL2,imgR2];
    set(h.sldPlay, 'Max', tifs + 1,'Value', tifs + 1);
    sldPlay_move(h.sldPlay,[]);
end

%%  perform particle recognition
disp('Command line ready');
end

function cbnLoadMap(~, ~, ~)

end

%%  Slider Callbacks

function sldPlay_move(~, ~, ~)
global h img res prefs;
prefs.currentframe = round(get(h.sldPlay, 'Value'));
updateGUI(); % redraw GUI with images

end

%% MouseMove and ButtonDown Callbacks

function ax_ButtonDownFcn(hObj, ~, ~)
% processes mouse button down events
global h img prefs res;
h.caller = get(hObj, 'Parent');
c = find(h.caller==h.refax);
switch get(gcbf, 'SelectionType')
    case 'normal'
        if ~isfield(img{c}, 'raw')
            return;
        end
        % Left click: fixate zoom preview and set imgsel as pciture
        if ~isfield(res{c},'click')
           res{c}.click = 1; 
        else
            res{c}.click = ~res{c}.click;
        end
        
        if res{c}.click
            
            XY = floor(res{c}.lastpos);
            res{c}.sel{end + 1}.h = rectangle( 'Parent', h.caller, ...
                'Curvature', [1,1], ...
                'Position', [XY(1,1:2) - prefs.z,prefs.z * 2 + 1,prefs.z * 2 + 1], ...
                'EdgeColor',prefs.colors{c},...
                'ButtonDownFcn', @Click_DeleteMe);
             % label rectangle with particle number
           
            if ~isfield(res{c},'trace')
                res{c}.trace = {}; 
            end 
             if ~isfield(res{c},'XY')
                    res{c}.XY = {};
             end
                res{c}.XY{end + 1} = res{c}.lastpos;
                 res{c}.sel{end}.lbl = text(XY(1,1), XY(1,2), num2str(size(res{c}.XY,2),'%d'), 'horizontal','left', 'vertical','bottom','Color',prefs.colors{c},'HitTest', 'off', 'FontSize', 12);
                extractTrace(c); % extract trace
                
                plotTrace(c);   % plot trace in trace axes...
               
        end
    case 'alt'
        
end


end

function WindowButtonMotionFcn(~, ~, ~)
% processes mouse move events
global h prefs res img;
prefs.mouseXY = uint16((get(gcbf,'CurrentPoint')));
for i=1:size(res,2)
    if ~isfield(img{i}, 'raw')
        return;
    end
    axpan = get(h.refax(i),'Position') + [prefs.aO(1,1:2),0,0]; % 
    
    if min(prefs.mouseXY >= axpan(1,1:2)) && min(prefs.mouseXY <= (axpan(1,1:2) + axpan(1,3:4))) % check over which axes the cursor hovers...
        tmp = floor(get(h.refax(i), 'CurrentPoint'));
        res{i}.lastpos = tmp;
        
        if ~isfield(res{i}, 'sel')                                          % check for sel field and create if necessary
               res{i}.sel = {};
        end
        
        prefs.uitable(size(res{i}.sel,2) + 1, (i*2-1):i*2) = tmp(1,1:2);    
        set(h.tXY, 'Data', prefs.uitable)                                   % enter XY data into uitable
      
        set(h.refzax(i),...                                                 % set 'zoomed' ROI in zoom axes
            'Visible', 'on', ...
            'YLim', tmp(1,2) + prefs.z * [-1,1] ,...
            'XLim', tmp(1,1) + prefs.z * [-1,1]);
        
        
    end
end
end

%% Listbox Function



function Click_DeleteMe(hObj,~,~)
global res;
% deletes manual selection marker and label on click
res{c}.sel(end) = [];
end

function UpdateUItable()
global res h;


end

function prePlot()
global h res prefs;
set(h.trax, 'Children', []);
for i=1:4
   prefs.plot{i} = plot(h.trax, [1:size(res{i}.trace{end},2)], zeros([1,size(res{i}.trace{end},2)]),'Color', prefs.colors{c});
end
end

%% ALEX Callback

function cbx_alex_change(hObj,~,~)
% evaluates ALEX popup menu selection
global h prefs;
prefs.ALEX = get(hObj, 'Value');
alexString = {};
% fill ALEX channel select popup menu
switch prefs.ALEX
    case 1
        alexString{end + 1} = 'No ALEX';
        set(h.cbx_alexCurrent, 'Enable', 'off');
    otherwise
        for i = 1:prefs.ALEX
            alexString{end+1} = [num2str(i),'st. Ex.'];
        end
        set(h.cbx_alexCurrent, 'Enable', 'on');
end
prefs.ALEXcurrent = 1;
set(h.cbx_alexCurrent, 'String', alexString);
% refresh GUI and recalculate FRET traces...

end

function cbx_alexCurrent_change(hObj,~,~)
% currently selected ALEX channel to show
global prefs;
prefs.ALEXcurrent = get(hObj, 'Value');
end

%% Other GUI functions

function updateGUI()
% refreshes GUI
global h img prefs;
for i = 1:4
    if isfield(img{i},'raw')
        tif = img{i}.raw;
        %try
            h.g(i) = imshow(tif(:,:,prefs.currentframe), 'Parent', h.refax(i), 'DisplayRange', [min(min(tif(:,:,prefs.currentframe))),max(max(tif(:,:,prefs.currentframe)))], 'Colormap', colormap(gray));
            imshow(tif(:,:,prefs.currentframe), 'Parent', h.refzax(i), 'DisplayRange', [min(min(tif(:,:,prefs.currentframe))),max(max(tif(:,:,prefs.currentframe)))], 'Colormap', colormap(gray));
            res{i}.click = 0;
            set(h.boxes(i), 'Value', 1)
            set(h.refzax(i),'Visible', 'on');
            set(h.g(i), 'ButtonDownFcn',@ax_ButtonDownFcn, 'Tag', strcat('tifax',num2str(i)), 'HitTest', 'on');
        %catch
        %end
    end
end
end
##### SOURCE END #####
--></body></html>